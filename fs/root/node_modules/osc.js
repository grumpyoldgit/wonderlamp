var osc = require('osc-min');
var dgram = require('dgram');

var Client = function (host, port) {
    this.host = host;
    this.port = port;
    this._sock = dgram.createSocket('udp4');
    this.kill = function() {
        this._sock.close();
    };
    this.send = function(data) {
    	this._sock.send(data, 0, data.length, port, host);
    }
};

var my_client;

var value = 0;

var output_values = [0,0,0,0];

var CANNON_CHANNEL = 54;
var cannon_fire = 0; // gets decremented when positive until 0 again (no cannon fire)

module.exports = {
	connect: function(host, port) {
		console.log("Opening UDP datagram client to host " + host + " on port " + port);
		my_client = new Client(host, port);
	},
	transmitFaderData: function (faderNumber, floatValue) {
        var midiValue = Math.round(floatValue * 255.0);
        if (output_values[faderNumber] != midiValue) {
            output_values[faderNumber] = midiValue;
            var channelNumber = 50 + faderNumber;
            console.log("midiValue: " + midiValue + " channelNumber: " + channelNumber);
    		my_client.send(osc.toBuffer({address:'/midi', args: [
                // channel is the midi device (which will always be zero for this project)
                // status is the midi value for a given sensor
                // data1 is the "control change number" which corresponds to each sensor - we will start at 50
                // data2 is always b0 - probably corresponds to control change message type
                {type : "midi", value : { channel : 0, status: midiValue, data1: channelNumber, data2: 0xb0 } }
            ]}));
        }
		
		var max = 255;
		var min = 255;
		
		for (var x=0; x<output_values.length; x++) {
			if (output_values[x] > max) max = output_values[x];
			if (output_values[x] < min) min = output_values[x];
		}
		
		if ((max - min) < 5 && min > 5 && max < 200) cannon_fire = 100; // fire the cannon!
		
		if (cannon_fire > 0) {
			cannon_fire--;
			my_client.send(osc.toBuffer({adress:'/midi', args: [
				{type : "midi", value : { channel : 0, status: cannon_fire, data1: CANNON_CHANNEL, data2:0xb0 } }
			]}));
		}
	}
}